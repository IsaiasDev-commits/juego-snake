<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snake vs IA - Records por Rondas</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Press Start 2P', cursive;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: white;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow-x: hidden;
            padding: 10px;
            touch-action: manipulation;
        }
        
        .container {
            width: 100%;
            max-width: 800px;
            z-index: 10;
            position: relative;
        }
        
        /* Fondo animado */
        .background-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
            pointer-events: none;
        }
        
        .bg-circle {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            animation: float 15s infinite linear;
        }
        
        .bg-circle:nth-child(1) {
            width: 60px;
            height: 60px;
            top: 10%;
            left: 10%;
            animation-delay: 0s;
            animation-duration: 20s;
        }
        
        .bg-circle:nth-child(2) {
            width: 40px;
            height: 40px;
            top: 20%;
            left: 80%;
            animation-delay: 2s;
            animation-duration: 15s;
        }
        
        .bg-circle:nth-child(3) {
            width: 70px;
            height: 70px;
            top: 70%;
            left: 25%;
            animation-delay: 4s;
            animation-duration: 25s;
        }
        
        .bg-circle:nth-child(4) {
            width: 30px;
            height: 30px;
            top: 50%;
            left: 90%;
            animation-delay: 6s;
            animation-duration: 18s;
        }
        
        .bg-circle:nth-child(5) {
            width: 50px;
            height: 50px;
            top: 80%;
            left: 70%;
            animation-delay: 8s;
            animation-duration: 22s;
        }
        
        @keyframes float {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 0.5;
            }
            50% {
                opacity: 0.7;
            }
            100% {
                transform: translateY(-100vh) rotate(720deg);
                opacity: 0;
            }
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            background: rgba(0, 0, 0, 0.7);
            padding: 12px;
            border-radius: 8px;
            border: 2px solid #ffdd40;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 5px rgba(255, 221, 64, 0.5); }
            50% { box-shadow: 0 0 20px rgba(255, 221, 64, 0.8); }
            100% { box-shadow: 0 0 5px rgba(255, 221, 64, 0.5); }
        }
        
        h1 {
            font-size: 1.2rem;
            text-shadow: 2px 2px 0 #000;
            margin-right: 10px;
            text-align: center;
            flex: 1;
        }
        
        .score-board {
            display: flex;
            gap: 10px;
        }
        
        .score-board p {
            font-size: 0.7rem;
            background: rgba(0, 0, 0, 0.5);
            padding: 6px 10px;
            border-radius: 5px;
        }
        
        #gameContainer {
            position: relative;
            width: 100%;
            margin: 0 auto;
            border: 4px solid #ffdd40;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }
        
        #background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(45deg, rgba(40, 44, 52, 0.9), rgba(30, 34, 42, 0.9)),
                repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0, 0, 0, 0.1) 10px, rgba(0, 0, 0, 0.1) 20px);
            z-index: 1;
            opacity: 0.9;
            animation: subtleBackground 20s linear infinite;
            background-size: 200% 200%;
        }
        
        @keyframes subtleBackground {
            0% { background-position: 0% 0%; }
            100% { background-position: 100% 100%; }
        }
        
        canvas {
            display: block;
            width: 100%;
            background: rgba(40, 44, 52, 0.8);
            z-index: 2;
            position: relative;
        }
        
        #gameOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3;
        }
        
        .screen {
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 3px solid #ffdd40;
            max-width: 90%;
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .screen h2 {
            margin-bottom: 12px;
            color: #ffdd40;
            font-size: 1.2rem;
            text-shadow: 2px 2px 0 #000;
        }
        
        .screen p {
            margin: 10px 0;
            line-height: 1.5;
            font-size: 0.7rem;
        }
        
        .btn {
            background: linear-gradient(to bottom, #ffdd40, #ff9900);
            color: #000;
            border: none;
            padding: 10px 20px;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.7rem;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 0;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(255, 221, 64, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .controls {
            margin-top: 12px;
            font-size: 0.6rem;
            color: #aaa;
        }
        
        .hidden {
            display: none !important;
        }
        
        .game-controls {
            position: absolute;
            bottom: 15px;
            right: 15px;
            z-index: 10;
            display: flex;
            gap: 10px;
        }
        
        .icon-btn {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: 2px solid #ffdd40;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .icon-btn:hover {
            background: rgba(255, 221, 64, 0.2);
        }
        
        /* Instrucciones t√°ctiles */
        .touch-instructions {
            margin-top: 15px;
            text-align: center;
            font-size: 0.7rem;
            color: #ffdd40;
            padding: 8px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 5px;
        }
        
        .progress-container {
            margin-top: 10px;
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            overflow: hidden;
            height: 20px;
            position: relative;
        }
        
        .progress-player {
            position: absolute;
            height: 100%;
            background: linear-gradient(to right, #4caf50, #8bc34a);
            width: 0%;
            transition: width 0.5s;
            left: 0;
        }
        
        .progress-ia {
            position: absolute;
            height: 100%;
            background: linear-gradient(to left, #9c27b0, #673ab7);
            width: 0%;
            transition: width 0.5s;
            right: 0;
        }
        
        .progress-label {
            position: absolute;
            width: 100%;
            text-align: center;
            font-size: 0.6rem;
            line-height: 20px;
            color: white;
            text-shadow: 1px 1px 1px #000;
            z-index: 2;
        }
        
        .records-container {
            margin-top: 15px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 8px;
            border: 2px solid #ffdd40;
        }
        
        .records-title {
            text-align: center;
            font-size: 0.8rem;
            margin-bottom: 8px;
            color: #ffdd40;
        }
        
        .records-list {
            display: flex;
            justify-content: space-around;
            font-size: 0.7rem;
        }
        
        .record-item {
            text-align: center;
        }
        
        .record-value {
            font-size: 0.9rem;
            color: #ffdd40;
            margin-top: 3px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                gap: 10px;
            }
            
            h1 {
                font-size: 1rem;
                margin-right: 0;
            }
            
            .score-board {
                justify-content: center;
                width: 100%;
            }
            
            .screen {
                padding: 15px;
            }
            
            .screen h2 {
                font-size: 1rem;
            }
            
            .btn {
                padding: 8px 16px;
                font-size: 0.6rem;
            }
            
            .records-list {
                flex-direction: column;
                gap: 8px;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 8px;
            }
            
            h1 {
                font-size: 0.9rem;
            }
            
            .score-board {
                flex-direction: column;
                gap: 6px;
            }
            
            .score-board p {
                font-size: 0.6rem;
            }
            
            .screen {
                padding: 12px;
            }
            
            .screen h2 {
                font-size: 0.9rem;
                margin-bottom: 8px;
            }
            
            .screen p {
                font-size: 0.6rem;
            }
            
            .bg-circle {
                animation-duration: 12s !important;
            }
            
            .touch-instructions {
                font-size: 0.6rem;
            }
            
            .game-controls {
                bottom: 10px;
                right: 10px;
            }
            
            .icon-btn {
                width: 35px;
                height: 35px;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <!-- Fondo animado con CSS puro -->
    <div class="background-animation">
        <div class="bg-circle"></div>
        <div class="bg-circle"></div>
        <div class="bg-circle"></div>
        <div class="bg-circle"></div>
        <div class="bg-circle"></div>
    </div>

    <div class="container">
        <header>
            <h1>Snake vs IA - Por Rondas</h1>
            <div class="score-board">
                <p>T√∫: <span id="score">0</span>/50</p>
                <p>IA: <span id="iaScore">0</span>/50</p>
                <p>Ronda: <span id="round">1</span>/5</p>
            </div>
        </header>

        <div class="progress-container">
            <div class="progress-label">Carrera hacia la victoria</div>
            <div id="progressPlayer" class="progress-player"></div>
            <div id="progressIA" class="progress-ia"></div>
        </div>

        <div id="gameContainer">
            <div id="background"></div>
            <div id="gameOverlay">
                <div id="startScreen" class="screen">
                    <h2>Snake vs IA</h2>
                    <p>¬°Gana 3 de 5 rondas para ganar el juego!</p>
                    <p>Cada ronda: primero en 50 puntos gana</p>
                    <button id="startButton" class="btn">Comenzar Juego</button>
                    
                    <div class="records-container">
                        <div class="records-title">R√âCORDS</div>
                        <div class="records-list">
                            <div class="record-item">
                                <div>Victorias</div>
                                <div id="recordWins" class="record-value">0</div>
                            </div>
                            <div class="record-item">
                                <div>Rondas Ganadas</div>
                                <div id="recordRounds" class="record-value">0</div>
                            </div>
                            <div class="record-item">
                                <div>Mejor Racha</div>
                                <div id="recordStreak" class="record-value">0</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="pauseScreen" class="screen hidden">
                    <h2>Juego Pausado</h2>
                    <button id="resumeButton" class="btn">Continuar</button>
                </div>
                <div id="roundScreen" class="screen hidden">
                    <h2 id="roundTitle">¬°Ronda Completa!</h2>
                    <p id="roundMessage"></p>
                    <p>T√∫: <span id="roundPlayerScore">0</span> puntos</p>
                    <p>IA: <span id="roundIaScore">0</span> puntos</p>
                    <button id="nextRoundButton" class="btn">Siguiente Ronda</button>
                </div>
                <div id="gameOverScreen" class="screen hidden">
                    <h2 id="gameOverTitle">¬°Juego Terminado!</h2>
                    <p id="gameOverMessage"></p>
                    <p>Victorias: <span id="finalWins">0</span>/5</p>
                    <div class="records-container" style="margin-top: 15px;">
                        <div class="records-title">R√âCORDS ACTUALIZADOS</div>
                        <div class="records-list">
                            <div class="record-item">
                                <div>Victorias</div>
                                <div id="finalRecordWins" class="record-value">0</div>
                            </div>
                            <div class="record-item">
                                <div>Rondas Ganadas</div>
                                <div id="finalRecordRounds" class="record-value">0</div>
                            </div>
                            <div class="record-item">
                                <div>Mejor Racha</div>
                                <div id="finalRecordStreak" class="record-value">0</div>
                            </div>
                        </div>
                    </div>
                    <button id="restartButton" class="btn">Juego Nuevo</button>
                </div>
            </div>
            
            <canvas id="gameCanvas"></canvas>
        </div>

        <div class="game-controls">
            <button id="pauseButton" class="icon-btn hidden" aria-label="Pausar juego">‚è∏Ô∏è</button>
            <button id="restartRoundButton" class="icon-btn hidden" aria-label="Reiniciar ronda">‚Üª</button>
        </div>
        
        <!-- Instrucciones para controles t√°ctiles -->
        <div class="touch-instructions">
            Desliza el dedo en la pantalla para mover la serpiente
        </div>
    </div>

    <script>
        class SnakeGame {
            constructor() {
                this.canvas = document.getElementById("gameCanvas");
                this.ctx = this.canvas.getContext("2d");
                this.scoreDisplay = document.getElementById("score");
                this.iaScoreDisplay = document.getElementById("iaScore");
                this.roundDisplay = document.getElementById("round");
                this.recordWins = document.getElementById("recordWins");
                this.recordRounds = document.getElementById("recordRounds");
                this.recordStreak = document.getElementById("recordStreak");
                this.finalWins = document.getElementById("finalWins");
                this.finalRecordWins = document.getElementById("finalRecordWins");
                this.finalRecordRounds = document.getElementById("finalRecordRounds");
                this.finalRecordStreak = document.getElementById("finalRecordStreak");
                this.roundPlayerScore = document.getElementById("roundPlayerScore");
                this.roundIaScore = document.getElementById("roundIaScore");
                this.roundTitle = document.getElementById("roundTitle");
                this.roundMessage = document.getElementById("roundMessage");
                this.gameOverTitle = document.getElementById("gameOverTitle");
                this.gameOverMessage = document.getElementById("gameOverMessage");
                this.progressPlayer = document.getElementById("progressPlayer");
                this.progressIA = document.getElementById("progressIA");
                
                // Pantallas
                this.startScreen = document.getElementById("startScreen");
                this.pauseScreen = document.getElementById("pauseScreen");
                this.roundScreen = document.getElementById("roundScreen");
                this.gameOverScreen = document.getElementById("gameOverScreen");
                
                // Botones
                this.startButton = document.getElementById("startButton");
                this.restartButton = document.getElementById("restartButton");
                this.nextRoundButton = document.getElementById("nextRoundButton");
                this.resumeButton = document.getElementById("resumeButton");
                this.pauseButton = document.getElementById("pauseButton");
                this.restartRoundButton = document.getElementById("restartRoundButton");
                
                // Configuraci√≥n del juego
                this.box = 20;
                this.snake = [];
                this.snakeIA = [];
                this.dx = 0;
                this.dy = 0;
                this.food = {};
                this.score = 0;
                this.iaScore = 0;
                this.round = 1;
                this.maxRounds = 5;
                this.playerWins = 0;
                this.roundsToWin = 3;
                this.winningScore = 50;
                this.gameInterval = null;
                this.isPaused = false;
                this.gameStarted = false;
                this.touchStartX = 0;
                this.touchStartY = 0;
                this.iaMoveCounter = 0;
                this.iaMoveFrequency = 5;
                
                // Records
                this.totalWins = parseInt(localStorage.getItem('snakeTotalWins')) || 0;
                this.totalRounds = parseInt(localStorage.getItem('snakeTotalRounds')) || 0;
                this.bestStreak = parseInt(localStorage.getItem('snakeBestStreak')) || 0;
                this.currentStreak = 0;
                
                // Inicializar el juego
                this.init();
            }
            
            init() {
                // Ajustar el canvas
                this.resizeCanvas();
                window.addEventListener("resize", () => this.resizeCanvas());
                
                // Actualizar records
                this.updateRecordsDisplay();
                
                // Event listeners para botones
                this.startButton.addEventListener("click", () => this.startGame());
                this.restartButton.addEventListener("click", () => this.startNewGame());
                this.nextRoundButton.addEventListener("click", () => this.nextRound());
                this.resumeButton.addEventListener("click", () => this.togglePause());
                this.pauseButton.addEventListener("click", () => this.togglePause());
                this.restartRoundButton.addEventListener("click", () => this.restartRound());
                
                // Event listeners para touch
                this.canvas.addEventListener("touchstart", (e) => this.handleTouchStart(e), { passive: false });
                this.canvas.addEventListener("touchmove", (e) => this.handleTouchMove(e), { passive: false });
                
                // Dibujar pantalla de inicio
                this.drawStartScreen();
            }
            
            resizeCanvas() {
                // Ajustar el tama√±o del canvas para que sea responsivo
                const maxWidth = Math.min(500, window.innerWidth - 40);
                const maxHeight = Math.min(400, window.innerHeight - 200);
                
                const width = Math.floor(maxWidth / this.box) * this.box;
                const height = Math.floor(maxHeight / this.box) * this.box;
                
                this.canvas.width = width;
                this.canvas.height = height;
                
                if (this.gameStarted && !this.isPaused) {
                    this.food = this.generateFood();
                }
            }
            
            drawStartScreen() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                // T√≠tulo
                this.ctx.fillStyle = '#ffdd40';
                this.ctx.font = '16px "Press Start 2P", cursive';
                this.ctx.textAlign = 'center';
                this.ctx.fillText('Snake vs IA', this.canvas.width / 2, this.canvas.height / 3);
                
                // Instrucciones
                this.ctx.fillStyle = '#ffffff';
                this.ctx.font = '8px "Press Start 2P", cursive';
                this.ctx.fillText('Gana 3 de 5 rondas', this.canvas.width / 2, this.canvas.height / 2);
                this.ctx.fillText('Desliza para mover', this.canvas.width / 2, this.canvas.height / 2 + 15);
            }
            
            startNewGame() {
                // Reiniciar estad√≠sticas del juego
                this.round = 1;
                this.playerWins = 0;
                this.currentStreak = 0;
                this.startGame();
            }
            
            startGame() {
                // Ocultar pantallas
                this.startScreen.classList.add("hidden");
                this.gameOverScreen.classList.add("hidden");
                this.roundScreen.classList.add("hidden");
                this.pauseScreen.classList.add("hidden");
                this.pauseButton.classList.remove("hidden");
                this.restartRoundButton.classList.remove("hidden");
                
                // Actualizar display de ronda
                this.roundDisplay.textContent = this.round;
                
                // Inicializar serpiente del jugador
                this.snake = [
                    {x: 5 * this.box, y: 10 * this.box},
                    {x: 4 * this.box, y: 10 * this.box},
                    {x: 3 * this.box, y: 10 * this.box}
                ];
                
                // Inicializar serpiente IA en posici√≥n opuesta
                this.snakeIA = [
                    {x: (this.canvas.width/this.box - 5) * this.box, y: 10 * this.box},
                    {x: (this.canvas.width/this.box - 4) * this.box, y: 10 * this.box},
                    {x: (this.canvas.width/this.box - 3) * this.box, y: 10 * this.box}
                ];
                
                // Inicializar direcci√≥n
                this.dx = this.box;
                this.dy = 0;
                
                // Generar comida
                this.food = this.generateFood();
                
                // Reiniciar puntajes de la ronda
                this.score = 0;
                this.iaScore = 0;
                this.scoreDisplay.textContent = this.score;
                this.iaScoreDisplay.textContent = this.iaScore;
                this.updateProgressBars();
                
                // Configurar velocidad IA inicial
                this.iaMoveFrequency = 5;
                
                // Iniciar el juego
                this.gameStarted = true;
                this.isPaused = false;
                
                // Limpiar intervalo anterior si existe
                if (this.gameInterval) {
                    clearInterval(this.gameInterval);
                }
                
                // Iniciar el bucle del juego
                this.gameInterval = setInterval(() => this.update(), 150);
            }
            
            update() {
                if (this.isPaused) return;
                
                // Mover la serpiente del jugador
                const head = {x: this.snake[0].x + this.dx, y: this.snake[0].y + this.dy};
                
                // Detectar colisiones con los bordes
                if (
                    head.x < 0 || 
                    head.y < 0 || 
                    head.x >= this.canvas.width || 
                    head.y >= this.canvas.height
                ) {
                    this.finishRound(false);
                    return;
                }
                
                // Detectar colisiones consigo misma
                for (let i = 0; i < this.snake.length; i++) {
                    if (this.snake[i].x === head.x && this.snake[i].y === head.y) {
                        this.finishRound(false);
                        return;
                    }
                }
                
                // Detectar colisiones con la serpiente IA
                for (let i = 0; i < this.snakeIA.length; i++) {
                    if (this.snakeIA[i].x === head.x && this.snakeIA[i].y === head.y) {
                        this.finishRound(false);
                        return;
                    }
                }
                
                // A√±adir nueva cabeza
                this.snake.unshift(head);
                
                // Comer comida
                if (head.x === this.food.x && head.y === this.food.y) {
                    this.score += 10;
                    this.scoreDisplay.textContent = this.score;
                    this.updateProgressBars();
                    
                    // Verificar victoria en la ronda
                    if (this.score >= this.winningScore) {
                        this.finishRound(true);
                        return;
                    }
                    
                    this.food = this.generateFood();
                } else {
                    // Remover cola
                    this.snake.pop();
                }
                
                // Mover la serpiente IA
                this.iaMoveCounter++;
                if (this.iaMoveCounter >= this.iaMoveFrequency) {
                    this.iaMoveCounter = 0;
                    this.moveIA();
                }
                
                // Dibujar el juego
                this.draw();
            }
            
            moveIA() {
                // IA simple que busca la comida
                const iaHead = this.snakeIA[0];
                
                // Decidir direcci√≥n hacia la comida
                let dxIA = 0;
                let dyIA = 0;
                
                // Con cierta probabilidad, moverse aleatoriamente para hacerlo m√°s interesante
                if (Math.random() < 0.2) {
                    // Movimiento aleatorio
                    const directions = [{x: this.box, y: 0}, {x: -this.box, y: 0}, {x: 0, y: this.box}, {x: 0, y: -this.box}];
                    const randomDir = directions[Math.floor(Math.random() * directions.length)];
                    dxIA = randomDir.x;
                    dyIA = randomDir.y;
                } else {
                    // Movimiento hacia la comida
                    if (iaHead.x < this.food.x) dxIA = this.box;
                    else if (iaHead.x > this.food.x) dxIA = -this.box;
                    
                    if (iaHead.y < this.food.y) dyIA = this.box;
                    else if (iaHead.y > this.food.y) dyIA = -this.box;
                    
                    // A veces priorizar un eje sobre el otro
                    if (dxIA !== 0 && dyIA !== 0) {
                        if (Math.random() < 0.5) dyIA = 0;
                        else dxIA = 0;
                    }
                }
                
                // Prevenir movimiento inverso (para que no choque consigo misma)
                const currentDx = this.snakeIA[0].x - this.snakeIA[1].x;
                const currentDy = this.snakeIA[0].y - this.snakeIA[1].y;
                
                if (dxIA === -currentDx && dyIA === -currentDy) {
                    // Si intenta moverse en direcci√≥n opuesta, elegir una direcci√≥n alternativa
                    if (currentDx !== 0) {
                        dxIA = 0;
                        dyIA = Math.random() < 0.5 ? this.box : -this.box;
                    } else {
                        dyIA = 0;
                        dxIA = Math.random() < 0.5 ? this.box : -this.box;
                    }
                }
                
                // Calcular nueva cabeza de la IA
                const newHeadIA = {x: iaHead.x + dxIA, y: iaHead.y + dyIA};
                
                // Verificar colisiones con bordes (rebote)
                if (newHeadIA.x < 0 || newHeadIA.x >= this.canvas.width || 
                    newHeadIA.y < 0 || newHeadIA.y >= this.canvas.height) {
                    // Cambiar direcci√≥n si va a chocar con un borde
                    if (newHeadIA.x < 0 || newHeadIA.x >= this.canvas.width) dxIA = -dxIA;
                    if (newHeadIA.y < 0 || newHeadIA.y >= this.canvas.height) dyIA = -dyIA;
                    
                    newHeadIA.x = iaHead.x + dxIA;
                    newHeadIA.y = iaHead.y + dyIA;
                }
                
                // A√±adir nueva cabeza a la IA
                this.snakeIA.unshift(newHeadIA);
                
                // Verificar si la IA come la comida
                if (newHeadIA.x === this.food.x && newHeadIA.y === this.food.y) {
                    this.iaScore += 10;
                    this.iaScoreDisplay.textContent = this.iaScore;
                    this.updateProgressBars();
                    
                    // Verificar victoria de la IA en la ronda
                    if (this.iaScore >= this.winningScore) {
                        this.finishRound(false);
                        return;
                    }
                    
                    // Generar nueva comida si la IA la come
                    this.food = this.generateFood();
                } else {
                    // Remover cola de la IA
                    this.snakeIA.pop();
                }
            }
            
            draw() {
                // Limpiar el canvas
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                // Dibujar la serpiente del jugador
                this.snake.forEach((segment, index) => {
                    this.ctx.fillStyle = index === 0 ? '#ff5722' : '#4caf50';
                    this.ctx.fillRect(segment.x, segment.y, this.box, this.box);
                    
                    // A√±adir detalles a la cabeza
                    if (index === 0) {
                        this.ctx.fillStyle = '#000';
                        // Ojos
                        this.ctx.fillRect(segment.x + 3, segment.y + 3, 3, 3);
                        this.ctx.fillRect(segment.x + 10, segment.y + 3, 3, 3);
                    }
                });
                
                // Dibujar la serpiente IA
                this.snakeIA.forEach((segment, index) => {
                    this.ctx.fillStyle = index === 0 ? '#673ab7' : '#9c27b0';
                    this.ctx.fillRect(segment.x, segment.y, this.box, this.box);
                    
                    // A√±adir detalles a la cabeza
                    if (index === 0) {
                        this.ctx.fillStyle = '#000';
                        // Ojos
                        this.ctx.fillRect(segment.x + 3, segment.y + 3, 3, 3);
                        this.ctx.fillRect(segment.x + 10, segment.y + 3, 3, 3);
                    }
                });
                
                // Dibujar la comida
                this.ctx.fillStyle = '#ff0000';
                this.ctx.beginPath();
                this.ctx.arc(this.food.x + this.box/2, this.food.y + this.box/2, this.box/2, 0, Math.PI * 2);
                this.ctx.fill();
                
                // Detalles de la comida
                this.ctx.fillStyle = '#00ff00';
                this.ctx.beginPath();
                this.ctx.moveTo(this.food.x + this.box/2, this.food.y + 2);
                this.ctx.lineTo(this.food.x + this.box/2 - 3, this.food.y - 2);
                this.ctx.lineTo(this.food.x + this.box/2 + 3, this.food.y - 2);
                this.ctx.closePath();
                this.ctx.fill();
                
                // Dibujar informaci√≥n del juego
                this.ctx.fillStyle = '#ffffff';
                this.ctx.font = '10px "Press Start 2P", cursive';
                this.ctx.textAlign = 'left';
                this.ctx.fillText(`T√∫: ${this.score}`, 10, 15);
                this.ctx.fillText(`IA: ${this.iaScore}`, 10, 30);
                this.ctx.fillText(`Ronda: ${this.round}/${this.maxRounds}`, 10, 45);
            }
            
            generateFood() {
                // Generar comida en una posici√≥n aleatoria
                const x = Math.floor(Math.random() * (this.canvas.width / this.box)) * this.box;
                const y = Math.floor(Math.random() * (this.canvas.height / this.box)) * this.box;
                
                // Verificar que no est√© en ninguna serpiente
                for (let segment of this.snake) {
                    if (segment.x === x && segment.y === y) {
                        return this.generateFood();
                    }
                }
                
                for (let segment of this.snakeIA) {
                    if (segment.x === x && segment.y === y) {
                        return this.generateFood();
                    }
                }
                
                return {x, y};
            }
            
            updateProgressBars() {
                // Actualizar las barras de progreso
                const playerPercent = (this.score / this.winningScore) * 100;
                const iaPercent = (this.iaScore / this.winningScore) * 100;
                
                this.progressPlayer.style.width = `${playerPercent}%`;
                this.progressIA.style.width = `${iaPercent}%`;
            }
            
            finishRound(playerWon) {
                clearInterval(this.gameInterval);
                this.gameStarted = false;
                
                // Actualizar estad√≠sticas
                if (playerWon) {
                    this.playerWins++;
                    this.currentStreak++;
                    this.totalRounds++;
                    
                    // Actualizar mejor racha si es necesario
                    if (this.currentStreak > this.bestStreak) {
                        this.bestStreak = this.currentStreak;
                    }
                } else {
                    this.currentStreak = 0;
                    this.totalRounds++;
                }
                
                // Guardar records
                this.saveRecords();
                
                // Mostrar pantalla de ronda completada
                this.roundPlayerScore.textContent = this.score;
                this.roundIaScore.textContent = this.iaScore;
                
                if (playerWon) {
                    this.roundTitle.textContent = "¬°Ronda Ganada!";
                    this.roundMessage.textContent = "¬°Has ganado esta ronda!";
                } else {
                    this.roundTitle.textContent = "¬°Ronda Perdida!";
                    this.roundMessage.textContent = "La IA ha ganado esta ronda";
                }
                
                this.roundScreen.classList.remove("hidden");
                this.pauseButton.classList.add("hidden");
                this.restartRoundButton.classList.add("hidden");
                
                // Verificar si el juego ha terminado
                if (this.playerWins >= this.roundsToWin || this.round >= this.maxRounds) {
                    // Peque√±a demora antes de mostrar la pantalla de fin de juego
                    setTimeout(() => {
                        this.finishGame();
                    }, 1500);
                }
            }
            
            nextRound() {
                // Avanzar a la siguiente ronda
                this.round++;
                
                // Verificar si el juego ha terminado
                if (this.playerWins >= this.roundsToWin || this.round > this.maxRounds) {
                    this.finishGame();
                } else {
                    // Iniciar la siguiente ronda
                    this.roundDisplay.textContent = this.round;
                    this.startGame();
                }
            }
            
            restartRound() {
                // Reiniciar la ronda actual sin penalizaci√≥n
                if (this.gameStarted) {
                    this.startGame();
                }
            }
            
            finishGame() {
                // Actualizar victorias totales si el jugador gan√≥
                if (this.playerWins >= this.roundsToWin) {
                    this.totalWins++;
                }
                
                // Guardar records
                this.saveRecords();
                
                // Mostrar pantalla de fin de juego
                this.finalWins.textContent = this.playerWins;
                this.finalRecordWins.textContent = this.totalWins;
                this.finalRecordRounds.textContent = this.totalRounds;
                this.finalRecordStreak.textContent = this.bestStreak;
                
                if (this.playerWins >= this.roundsToWin) {
                    this.gameOverTitle.textContent = "¬°Has Ganado!";
                    this.gameOverMessage.textContent = `¬°Ganaste ${this.playerWins} de ${this.maxRounds} rondas!`;
                } else {
                    this.gameOverTitle.textContent = "¬°Juego Terminado!";
                    this.gameOverMessage.textContent = `Ganaste ${this.playerWins} de ${this.maxRounds} rondas`;
                }
                
                this.gameOverScreen.classList.remove("hidden");
                this.pauseButton.classList.add("hidden");
                this.restartRoundButton.classList.add("hidden");
            }
            
            saveRecords() {
                // Guardar records en localStorage
                localStorage.setItem('snakeTotalWins', this.totalWins);
                localStorage.setItem('snakeTotalRounds', this.totalRounds);
                localStorage.setItem('snakeBestStreak', this.bestStreak);
                
                // Actualizar display de records
                this.updateRecordsDisplay();
            }
            
            updateRecordsDisplay() {
                // Actualizar la visualizaci√≥n de records
                this.recordWins.textContent = this.totalWins;
                this.recordRounds.textContent = this.totalRounds;
                this.recordStreak.textContent = this.bestStreak;
            }
            
            togglePause() {
                if (!this.gameStarted) return;
                
                this.isPaused = !this.isPaused;
                
                if (this.isPaused) {
                    this.pauseScreen.classList.remove("hidden");
                } else {
                    this.pauseScreen.classList.add("hidden");
                }
            }
            
            handleTouchStart(e) {
                // Prevenir el desplazamiento
                e.preventDefault();
                
                // Guardar la posici√≥n inicial del toque
                this.touchStartX = e.touches[0].clientX;
                this.touchStartY = e.touches[0].clientY;
            }
            
            handleTouchMove(e) {
                // Prevenir el desplazamiento
                e.preventDefault();
                
                if (!this.touchStartX || !this.touchStartY || !this.gameStarted || this.isPaused) {
                    return;
                }
                
                // Obtener la posici√≥n actual del toque
                const touchX = e.touches[0].clientX;
                const touchY = e.touches[0].clientY;
                
                // Calcular la diferencia
                const dx = touchX - this.touchStartX;
                const dy = touchY - this.touchStartY;
                
                // Determinar la direcci√≥n basada en el movimiento m√°s significativo
                if (Math.abs(dx) > Math.abs(dy)) {
                    // Movimiento horizontal
                    if (dx > 0 && this.dx === 0) {
                        // Derecha
                        this.dx = this.box;
                        this.dy = 0;
                    } else if (dx < 0 && this.dx === 0) {
                        // Izquierda
                        this.dx = -this.box;
                        this.dy = 0;
                    }
                } else {
                    // Movimiento vertical
                    if (dy > 0 && this.dy === 0) {
                        // Abajo
                        this.dx = 0;
                        this.dy = this.box;
                    } else if (dy < 0 && this.dy === 0) {
                        // Arriba
                        this.dx = 0;
                        this.dy = -this.box;
                    }
                }
                
                // Actualizar la posici√≥n inicial para el pr√≥ximo movimiento
                this.touchStartX = touchX;
                this.touchStartY = touchY;
            }
        }

        // Inicializar el juego cuando se carga la p√°gina
        window.onload = function() {
            const game = new SnakeGame();
        };
    </script>
</body>
</html>